<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>eMigrant — Miniapp MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Telegram Web Apps SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0f1115;--card:#171a21;--text:#e7eaf0;--muted:#9aa3b2;--accent:#7cdfff;--line:#242936;--ok:#33d69e;--warn:#ffb84d;}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:16px 16px 86px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:12px}
    h1,h2,h3{margin:0 0 10px} .small{color:var(--muted);font-size:13px}
    input,select,button,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0c0f14;color:var(--text);margin-top:6px}
    button{cursor:pointer} button.primary{background:#2a73ff;border-color:#2a73ff}
    .row{display:flex;gap:8px;align-items:center} .row> *{flex:1}
    .progress{height:10px;background:#0c0f14;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:#2a73ff}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);color:var(--muted)}
    .ok{color:var(--ok);border-color:var(--ok)} .warn{color:var(--warn);border-color:var(--warn)}
    .bottom{position:fixed;left:0;right:0;bottom:0;background:#0c0f14;border-top:1px solid var(--line);display:flex;gap:6px;padding:8px}
    .bottom button{flex:1}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0f1115,rgba(15,17,21,0.6));backdrop-filter:blur(6px);z-index:2;border-bottom:1px solid var(--line);padding:12px}
    .hint{margin:8px 0 0}
  </style>
</head>
<body>
<div class="wrap">
  <header><h2 id="title">eMigrant · Онбординг</h2></header>

  <!-- Онбординг (8 вопросов) -->
  <div id="onb" class="card">
    <div class="badge">Шаг <span id="step">1</span>/8</div>

    <!-- Q1: Имя/Фамилия -->
    <div id="q1">
      <h3>1) Как тебя зовут?</h3>
      <label>Имя</label>
      <input id="firstName" placeholder="Имя"/>
      <label>Фамилия</label>
      <input id="lastName" placeholder="Фамилия"/>
      <div class="row" style="margin-top:10px">
        <span></span>
        <button class="primary" onclick="nextQ(2)">Далее</button>
      </div>
    </div>

    <!-- Q2: Воеводство -->
    <div id="q2" style="display:none">
      <h3>2) Где ты живёшь?</h3>
      <select id="voivodeship">
        <option value="Mazowieckie">Mazowieckie</option>
        <option value="Małopolskie">Małopolskie</option>
        <option value="Pomorskie">Pomorskie</option>
        <option value="Dolnośląskie">Dolnośląskie</option>
        <option value="Inne">Inne</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(1)">Назад</button>
        <button class="primary" onclick="nextQ(3)">Далее</button>
      </div>
    </div>

    <!-- Q3: Гражданство -->
    <div id="q3" style="display:none">
      <h3>3) Гражданство</h3>
      <select id="citizenship">
        <option value="UKR">Укр</option>
        <option value="BLR">Бел</option>
        <option value="RUS">Рус</option>
        <option value="Other">Другое</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(2)">Назад</button>
        <button class="primary" onclick="nextQ(4)">Далее</button>
      </div>
    </div>

    <!-- Q4: Срок пребывания -->
    <div id="q4" style="display:none">
      <h3>4) Сколько времени ты в Польше?</h3>
      <select id="stayLength">
        <option value="2-3">2–3 года</option>
        <option value="<=1">год и меньше</option>
        <option value=">=4">больше 4 лет</option>
        <option value="new">только приехал</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(3)">Назад</button>
        <button class="primary" onclick="nextQ(5)">Далее</button>
      </div>
    </div>

    <!-- Q5: Текущий статус -->
    <div id="q5" style="display:none">
      <h3>5) Твой текущий статус</h3>
      <select id="currentStatus">
        <option value="waiting">Жду</option>
        <option value="refused">Получил отказ</option>
        <option value="statusUKR">Status UKR</option>
        <option value="pobytCzasowy">Pobyt Czasowy</option>
        <option value="other">Inne (Karta Polaka, Karta Rezydenta UE)</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(4)">Назад</button>
        <button class="primary" onclick="nextQ(6)">Далее</button>
      </div>
    </div>

    <!-- Q6: Основания (множественный выбор) -->
    <div id="q6" style="display:none">
      <h3>6) Какие у тебя могут быть основания для ВНЖ?</h3>
      <div class="small">Можно выбрать несколько.</div>
      <label><input type="checkbox" class="grounds" value="UoP"> Работа (UoP)</label>
      <label><input type="checkbox" class="grounds" value="UoD"> Работа (UoD)</label>
      <label><input type="checkbox" class="grounds" value="UoZ"> Работа (UoZ)</label>
      <label><input type="checkbox" class="grounds" value="Dzialalnosc"> Работа (Działalność)</label>
      <label><input type="checkbox" class="grounds" value="Study"> Учёба</label>
      <label><input type="checkbox" class="grounds" value="Family"> Семья</label>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(5)">Назад</button>
        <button class="primary" onclick="nextQ(7)">Далее</button>
      </div>
    </div>

    <!-- Q7: Доход -->
    <div id="q7" style="display:none">
      <h3>7) Твой ежемесячный доход (brutto)</h3>
      <select id="income">
        <option value="<4700">до 4700</option>
        <option value="4800-10000">4800–10000</option>
        <option value=">10000">10000+</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(6)">Назад</button>
        <button class="primary" onclick="nextQ(8)">Далее</button>
      </div>
    </div>

    <!-- Q8: Долгосрочная цель -->
    <div id="q8" style="display:none">
      <h3>8) Твоя долгосрочная цель в Польше</h3>
      <select id="goal">
        <option value="wait">Переждать бурю</option>
        <option value="euResidentMaybe">Получить резидента, но насчёт паспорта неуверен</option>
        <option value="passport">Получить паспорт</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(7)">Назад</button>
        <button class="primary" onclick="finishOnb()">Продолжить</button>
      </div>
      <div class="small" style="margin-top:8px">Кнопка «Продолжить» просто перейдёт к чеклисту (PDF не генерируется на этом этапе).</div>
    </div>
  </div>

  <!-- Чеклист -->
  <div id="home" style="display:none">
    <div class="card">
      <h3>Прогресс</h3>
      <div class="progress"><span id="progressBar" style="width:0%"></span></div>
      <div class="small" style="margin-top:6px">Готово: <span id="doneCount">0</span>/<span id="totalCount">0</span></div>
      <div id="officeHint" class="small hint"></div>
    </div>

    <div id="tasks"></div>
  </div>
</div>

<!-- Нижнее меню -->
<div class="bottom">
  <button onclick="openChecklist()">Checklist</button>
  <button onclick="openModule('aiTranslator')">AI Translator</button>
  <button onclick="openModule('findSlot')">Book a slot</button>
  <button onclick="openModule('bookAssistant')">Start a chat</button>
</div>

<script>
  // ===== ИНИЦ Telegram WebApp (мягко, чтобы работало и в браузере)
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  try { tg && tg.ready(); tg && tg.expand(); } catch(e) {}

  // === Открыть личный чат с поддержкой (emigrate_support) ===
  function openSupportChat() {
    const urlTme = 'https://t.me/emigrate_support';
    const tgById = 'tg://user?id=7437456248'; // глубокая ссылка по ID (необязательно)

    try { tg?.HapticFeedback?.impactOccurred('light'); } catch {}

    if (tg && typeof tg.openTelegramLink === 'function') {
      // Надёжно для мини-аппа: Telegram сам решит, чем открыть ссылку
      tg.openTelegramLink(urlTme);
      // Доп. попытка через tg:// по ID
      setTimeout(() => { try { tg.openTelegramLink(tgById); } catch {} }, 200);
    } else {
      // Локальная отладка в обычном браузере
      window.location.href = urlTme;
    }
  }

  // ===== ПРОСТЕЙШЕЕ СОСТОЯНИЕ (localStorage)
  const st = {
    track: localStorage.getItem('track') || null,
    tasks: JSON.parse(localStorage.getItem('tasks')||'[]'),
    profile: JSON.parse(localStorage.getItem('profile')||'{}')
  };

  // Базовые задачи по треку (упрощённо под твои правила)
  function baseTasks(track){
    const common = [
      {id:'wniosek', title:'Wniosek (PDF)', status:'todo', requiresAI:true, kind:'wniosek'},
      {id:'photos', title:'Фотографии', status:'todo', requiresAI:false, kind:'photos'},
      {id:'skarb', title:'Opłata skarbowa', status:'todo', requiresAI:false, kind:'skarb'},
      {id:'rent', title:'Umowa najmu / Meldunek', status:'todo', requiresAI:true, kind:'rent'},
      {id:'ins', title:'Ubezpieczenie', status:'todo', requiresAI:true, kind:'insurance'},
      {id:'slot', title:'Find a slot', status:'todo', requiresAI:false, kind:'slot'},
      {id:'ai', title:'AI Translator', status:'todo', requiresAI:false, kind:'aiTranslator'},
      {id:'assist', title:'Book an assistant', status:'todo', requiresAI:false, kind:'bookAssistant'}
    ];
    if(track==='work'||track==='business'){
      common.splice(2,0,{id:'contract', title:'Контракт / Основание', status:'todo', requiresAI:true, kind:'contract'});
      common.splice(3,0,{id:'hr', title:'Załącznik od pracodawcy', status:'todo', requiresAI:true, kind:'attachmentHR'});
    }
    if(track==='study'){
      common.splice(2,0,{id:'uni', title:'Справка из вуза', status:'todo', requiresAI:true, kind:'university'});
      common.splice(3,0,{id:'funds', title:'Информация о средствах', status:'todo', requiresAI:true, kind:'funds'});
    }
    return common;
  }

  // Маппинг воеводства → подсказка/ссылка (заглушки)
  function officeHintByVoiv(v){
    const map = {
      'Mazowieckie': 'Ваш ужонд: Mazowiecki. Подсказка по формулярам: https://mazowieckie.example',
      'Małopolskie': 'Ваш ужонд: Małopolski. Подсказка по формулярам: https://malopolskie.example',
      'Pomorskie': 'Ваш ужонд: Pomorski. Подсказка по формулярам: https://pomorskie.example',
      'Dolnośląskie': 'Ваш ужонд: Dolnośląski. Подсказка по формулярам: https://dolnoslaskie.example',
      'Inne': 'Подсказки по ужондам для вашего региона: https://gov.example'
    };
    return map[v] || '';
  }

  // Определяем трек по основаниям (Q6)
  function determineTrack(groundValues){
    const has = k => groundValues.includes(k);
    if (has('Study')) return 'study';
    if (has('Family')) return 'family';
    if (has('Dzialalnosc')) return 'business';
    if (has('UoP') || has('UoD') || has('UoZ')) return 'work';
    return 'work';
  }

  // Рендер прогресса и задач
  function renderChecklist(){
    const title = st.profile?.trackLabel ? `eMigrant · Чеклист (${st.profile.trackLabel})` : 'eMigrant · Чеклист';
    document.getElementById('title').innerText = title;

    const tasksDiv = document.getElementById('tasks');
    tasksDiv.innerHTML = '';
    const done = st.tasks.filter(t=>t.status==='done').length;
    const total = st.tasks.length || 1;
    document.getElementById('doneCount').innerText = done;
    document.getElementById('totalCount').innerText = total;
    document.getElementById('progressBar').style.width = Math.round(done/total*100)+'%';

    document.getElementById('officeHint').innerText = st.profile?.voivodeship ? officeHintByVoiv(st.profile.voivodeship) : '';

    st.tasks.forEach(t=>{
      const card = document.createElement('div');
      card.className='card';
      const badgeClass = t.status==='done'?'ok':(t.status==='inreview'?'warn':'');
      card.innerHTML = `
        <div class="row" style="align-items:center">
          <div style="flex:3">
            <h3 style="margin:0 0 6px">${t.title}</h3>
            <span class="badge ${badgeClass}">${t.status==='todo'?'To do':t.status==='inreview'?'In review':'Done'}</span>
            ${t.requiresAI?'<span class="small" style="margin-left:8px">Рекомендуется AI-проверка</span>':''}
          </div>
          <div style="flex:2">
            <div class="row">
              <button class="primary" onclick="openModule('${t.kind}')">Открыть</button>
              ${t.status!=='done'?'<button onclick="markDone(\''+t.id+'\')">Сделано</button>':''}
            </div>
          </div>
        </div>
      `;
      tasksDiv.appendChild(card);
    });
  }

  function markDone(id){
    st.tasks = st.tasks.map(t=> t.id===id ? {...t, status:'done'} : t);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));
    renderChecklist();
  }

  // ===== Навигация
  function openChecklist(){
    document.getElementById('onb').style.display = 'none';
    document.getElementById('home').style.display = 'block';
    renderChecklist();
  }

  function openModule(kind){
    if(kind==='aiTranslator'){
      alert('AI Translator: Загрузите письмо/документ → перевод и краткое резюме. (В MVP-заглушке загрузка опущена)');
      return;
    }
    if(kind==='findSlot'){
      const dates = prompt('Укажите даты/дни, когда вы доступны (например: Пн/Ср/Пт или 20-25 августа). Мы мониторим, но слот не гарантирован.');
      alert('Спасибо! Подписка на обновления оформлена.\nВаши доступные дни: '+(dates||'не указано')+'\nПодтверждение визита — вручную.');
      return;
    }
    if(kind==='bookAssistant'){
      // ← Start a chat: открываем чат поддержки
      openSupportChat();
      return;
    }
    if(kind==='photos'){
      alert('Фото: гайд по размеру/фону. Загрузите фото (AI-проверка качества отключена в MVP).');
      return;
    }
    if(kind==='insurance'){
      const has = confirm('Есть действующая страховка? Нажмите OK если да, Отмена если пока нет.');
      if(!has){
        alert('Нажмите «Start a chat», чтобы обсудить, как оформить страховку.');
      } else {
        alert('Загрузите полис. AI-проверка: срок действия и реквизиты.');
      }
      return;
    }
    if(kind==='wniosek'){
      const path = confirm('У вас уже есть готовый скан внеска? (OK — загрузить скан; Отмена — пройти анкету и сгенерировать PDF)');
      if(path){
        alert('Загрузите скан. AI-проверка: подпись, даты, совпадение ФИО.');
      } else {
        alert('Откроется анкета внеска → затем можно сгенерировать PDF и распечатать.');
      }
      return;
    }
    if(kind==='contract'){
      alert('Загрузите договор (UoP/UoD/UoZ/B2B). AI-проверка: NIP, даты, подписи. Можно завершить вручную.');
      return;
    }
    if(kind==='attachmentHR'){
      alert('Скачайте шаблон, отдайте HR. Затем загрузите подписанный/с печатью документ (AI-проверка).');
      return;
    }
    if(kind==='rent'){
      alert('Загрузите договор аренды или meldunek. AI-проверка: адрес, сроки, подписи. Если нет — покажем инструкцию.');
      return;
    }
    if(kind==='university'){
      alert('Справка из вуза: Загрузка → AI-проверка. Если нет — инструкция, где получить.');
      return;
    }
    if(kind==='funds'){
      alert('Информация о средствах: Загрузите банковскую справку. AI-проверка — сумма/дата/реквизиты.');
      return;
    }
    if(kind==='skarb'){
      const paid = confirm('Оплатили госпошлину? (OK — да; Отмена — нет)');
      if(paid){
        alert('Отметили как выполнено. (Можно прикрепить чек — опционально в MVP)');
      } else {
        alert('Покажем реквизиты и короткую инструкцию по оплате.');
      }
      return;
    }
  }

  // ===== Онбординг (8 шагов)
  function showQ(n){
    for(let i=1;i<=8;i++){ document.getElementById('q'+i).style.display = (i===n)?'':'none' }
    document.getElementById('step').innerText = String(n);
  }
  function nextQ(n){ showQ(n) }
  function prevQ(n){ showQ(n) }

  function finishOnb(){
    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const voivodeship = document.getElementById('voivodeship').value;
    const citizenship = document.getElementById('citizenship').value;
    const stayLength = document.getElementById('stayLength').value;
    const currentStatus = document.getElementById('currentStatus').value;
    const income = document.getElementById('income').value;
    const goal = document.getElementById('goal').value;
    const grounds = Array.from(document.querySelectorAll('.grounds'))
      .filter(el=>el.checked)
      .map(el=>el.value);

    const track = determineTrack(grounds);
    const trackLabel = track==='work'?'Работа':track==='study'?'Учёба':track==='family'?'Семья':'Бизнес';

    st.profile = { firstName, lastName, voivodeship, citizenship, stayLength, currentStatus, grounds, income, goal, track, trackLabel };
    localStorage.setItem('profile', JSON.stringify(st.profile));

    st.track = track;
    st.tasks = baseTasks(track);
    localStorage.setItem('track', track);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));

    document.getElementById('onb').style.display='none';
    document.getElementById('home').style.display='';
    renderChecklist();
  }

  // Автозагрузка
  (function init(){
    if(st.track){
      document.getElementById('onb').style.display='none';
      document.getElementById('home').style.display='';
      renderChecklist();
    } else {
      showQ(1);
    }
  })();
</script>
</body>
</html>
